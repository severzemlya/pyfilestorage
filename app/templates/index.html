{% extends "base.html" %}
{% block title %}Files - {{ app_name }}{% endblock %}
{% block og_title %}Files - {{ app_name }}{% endblock %}
{% block og_description %}Browse and manage your files on {{ app_name }}{% endblock %}
{% block twitter_title %}Files - {{ app_name }}{% endblock %}
{% block twitter_description %}Browse and manage your files on {{ app_name }}{% endblock %}

{% block content %}
<div class="dashboard file-explorer">
    <!-- Header with breadcrumbs and actions -->
    <div class="dashboard-header">
        <div class="breadcrumbs">
            <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> <span data-i18n="file_explorer.home">Home</span></a>
            {% for crumb in breadcrumbs %}
            <span class="separator">/</span>
            <a href="{{ url_for('index', folder=crumb.id) }}">{{ crumb.name }}</a>
            {% endfor %}
        </div>

        <div class="header-actions">
            <form method="GET" class="search-form">
                <div class="search-box">
                    <input type="text" name="search" value="{{ search }}"
                           placeholder="Search files..." data-i18n-placeholder="file_explorer.search_files">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Actions bar -->
    <div class="actions-bar">
        <button class="btn btn-primary" onclick="document.getElementById('create-folder-modal').classList.add('active')">
            <i class="fas fa-folder-plus"></i> <span data-i18n="file_explorer.new_folder">New Folder</span>
        </button>
        <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-upload"></i> <span data-i18n="file_explorer.upload_files">Upload Files</span>
        </button>
        <button class="btn btn-secondary" onclick="document.getElementById('folder-input').click()">
            <i class="fas fa-folder-open"></i> <span data-i18n="file_explorer.upload_folder">Upload Folder</span>
        </button>
        <form id="upload-form" method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="folder_id" value="{{ current_folder.id if current_folder else '' }}">
            <input type="file" id="file-input" name="files" multiple>
            <input type="file" id="folder-input" name="files" webkitdirectory multiple>
        </form>

        <!-- Bulk actions (hidden by default, shown when items are selected) -->
        <div class="bulk-actions" id="bulk-actions" style="display: none;">
            <span class="selection-count"><span id="selected-count">0</span> <span data-i18n="file_explorer.selected_items">selected</span></span>
            <button class="btn btn-danger" onclick="deleteSelected()" id="delete-selected-btn">
                <i class="fas fa-trash"></i> <span data-i18n="file_explorer.delete_selected">Delete Selected</span>
            </button>
        </div>

        <!-- Sort dropdown -->
        <div class="sort-dropdown">
            <button class="btn btn-secondary" id="sort-toggle">
                <i class="fas fa-sort"></i> <span data-i18n="sorting.sort_by">Sort by</span>
            </button>
            <div class="sort-menu" id="sort-menu">
                <button class="sort-option" data-sort="name" data-order="asc"><i class="fas fa-sort-alpha-down"></i> <span data-i18n="sorting.name_asc">Name (A-Z)</span></button>
                <button class="sort-option" data-sort="name" data-order="desc"><i class="fas fa-sort-alpha-up"></i> <span data-i18n="sorting.name_desc">Name (Z-A)</span></button>
                <button class="sort-option" data-sort="size" data-order="asc"><i class="fas fa-sort-numeric-down"></i> <span data-i18n="sorting.size_asc">Size (Smallest)</span></button>
                <button class="sort-option" data-sort="size" data-order="desc"><i class="fas fa-sort-numeric-up"></i> <span data-i18n="sorting.size_desc">Size (Largest)</span></button>
                <button class="sort-option" data-sort="date" data-order="asc"><i class="fas fa-calendar"></i> <span data-i18n="sorting.date_asc">Date (Oldest)</span></button>
                <button class="sort-option" data-sort="date" data-order="desc"><i class="fas fa-calendar-alt"></i> <span data-i18n="sorting.date_desc">Date (Newest)</span></button>
            </div>
        </div>
    </div>

    <!-- Drop zone -->
    <div id="drop-zone" class="drop-zone">
        <i class="fas fa-cloud-upload-alt"></i>
        <p data-i18n="file_explorer.drop_files_here">Drop files here to upload</p>
    </div>

    <!-- Content section - File Explorer Table View -->
    <div class="content-section">
        {% if search %}
        <h3><i class="fas fa-search"></i> <span data-i18n="file_explorer.search_results_for">Search Results for</span> "{{ search }}"</h3>
        {% endif %}

        {% if folders or files %}
        <div class="file-explorer-table-container">
            <table class="file-explorer-table" id="file-table">
                <thead>
                    <tr>
                        <th class="checkbox-col">
                            <input type="checkbox" id="select-all" title="Select All" data-i18n-title="file_explorer.select_all">
                        </th>
                        <th class="icon-col"></th>
                        <th class="name-col sortable" data-sort="name">
                            <span data-i18n="file_explorer.name">Name</span>
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="size-col sortable" data-sort="size">
                            <span data-i18n="file_explorer.size">Size</span>
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="date-col sortable" data-sort="date">
                            <span data-i18n="file_explorer.modified">Modified</span>
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="actions-col">
                            <span data-i18n="file_explorer.actions">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="file-list">
                    <!-- Folders -->
                    {% for folder in folders %}
                    <tr class="file-row folder-row" data-type="folder" data-id="{{ folder.id }}" data-name="{{ folder.name }}" data-size="0" data-date="{{ folder.created_at }}">
                        <td class="checkbox-col">
                            <input type="checkbox" class="item-checkbox" data-type="folder" data-id="{{ folder.id }}">
                        </td>
                        <td class="icon-col">
                            <div class="file-icon-small folder-icon">
                                <i class="fas fa-folder"></i>
                            </div>
                        </td>
                        <td class="name-col">
                            <a href="{{ url_for('index', folder=folder.id) }}" class="file-name-link">{{ folder.name }}</a>
                        </td>
                        <td class="size-col">—</td>
                        <td class="date-col">{{ folder.created_at.strftime('%Y-%m-%d %H:%M') if folder.created_at else '—' }}</td>
                        <td class="actions-col">
                            <div class="row-actions">
                                <a href="{{ url_for('download_folder', folder_id=folder.id) }}" class="btn-icon" title="Download" data-i18n-title="actions.download">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button class="btn-icon" title="Share" data-i18n-title="actions.share" onclick="window.location.href='{{ url_for('share_folder', folder_id=folder.id) }}'">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="btn-icon" title="Rename" data-i18n-title="actions.rename" onclick="openRenameModal('folder', {{ folder.id }}, '{{ folder.name }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="POST" action="{{ url_for('delete_folder', folder_id=folder.id) }}" style="display: inline;"
                                      class="delete-form" data-confirm-key="confirm.delete_folder">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn-icon danger" title="Delete" data-i18n-title="actions.delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Files -->
                    {% for file in files %}
                    <tr class="file-row" data-type="file" data-id="{{ file.id }}" data-name="{{ file.original_name }}" data-size="{{ file.size }}" data-date="{{ file.created_at }}" draggable="true">
                        <td class="checkbox-col">
                            <input type="checkbox" class="item-checkbox" data-type="file" data-id="{{ file.id }}">
                        </td>
                        <td class="icon-col">
                            {% if get_file_type(file.mime_type) == 'image' %}
                            <div class="file-thumbnail" data-file-id="{{ file.id }}">
                                <img src="{{ url_for('get_thumbnail', file_id=file.id) }}" alt="" loading="lazy" onerror="this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="file-icon-small image-icon" style="display:none"><i class="fas fa-image"></i></div>
                            </div>
                            {% elif get_file_type(file.mime_type) == 'video' %}
                            <div class="file-thumbnail video-thumbnail" data-file-id="{{ file.id }}">
                                <img src="{{ url_for('get_thumbnail', file_id=file.id) }}" alt="" loading="lazy" onerror="this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="file-icon-small video-icon" style="display:none"><i class="fas fa-video"></i></div>
                                <div class="video-play-icon"><i class="fas fa-play"></i></div>
                            </div>
                            {% else %}
                            <div class="file-icon-small {{ get_file_type(file.mime_type) }}-icon">
                                {% if get_file_type(file.mime_type) == 'audio' %}
                                <i class="fas fa-music"></i>
                                {% elif get_file_type(file.mime_type) == 'pdf' %}
                                <i class="fas fa-file-pdf"></i>
                                {% elif get_file_type(file.mime_type) == 'text' %}
                                <i class="fas fa-file-alt"></i>
                                {% else %}
                                <i class="fas fa-file"></i>
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        <td class="name-col">
                            <span class="file-name-text" title="{{ file.original_name }}">{{ file.original_name }}</span>
                        </td>
                        <td class="size-col">{{ format_size(file.size) }}</td>
                        <td class="date-col">{{ file.created_at.strftime('%Y-%m-%d %H:%M') if file.created_at else '—' }}</td>
                        <td class="actions-col">
                            <div class="row-actions">
                                {% if get_file_type(file.mime_type) in ['image', 'video', 'audio', 'pdf'] %}
                                <a href="{{ url_for('preview_file', file_id=file.id) }}" class="btn-icon" title="Preview" data-i18n-title="actions.preview">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% endif %}
                                <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn-icon" title="Download" data-i18n-title="actions.download">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button class="btn-icon" title="Share" data-i18n-title="actions.share" onclick="window.location.href='{{ url_for('share_file', file_id=file.id) }}'">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="btn-icon" title="Rename" data-i18n-title="actions.rename" onclick="openRenameModal('file', {{ file.id }}, '{{ file.original_name }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="POST" action="{{ url_for('delete_file', file_id=file.id) }}" style="display: inline;"
                                      class="delete-form" data-confirm-key="confirm.delete_file">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn-icon danger" title="Delete" data-i18n-title="actions.delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if not folders and not files and not search %}
        <div class="empty-state">
            <i class="fas fa-folder-open"></i>
            <h3 data-i18n="file_explorer.empty_folder">This folder is empty</h3>
            <p data-i18n="file_explorer.upload_or_create">Upload files or create folders to get started</p>
        </div>
        {% elif search and not folders and not files %}
        <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3 data-i18n="file_explorer.no_results_found">No results found</h3>
            <p data-i18n="file_explorer.try_different_search">Try a different search term</p>
        </div>
        {% endif %}
    </div>

    <!-- Shared with me section -->
    {% if shared_files or shared_folders %}
    <div class="content-section shared-section">
        <h3><i class="fas fa-users"></i> <span data-i18n="file_explorer.shared_with_me">Shared with me</span></h3>

        <div class="file-explorer-table-container">
            <table class="file-explorer-table">
                <thead>
                    <tr>
                        <th class="icon-col"></th>
                        <th class="name-col"><span data-i18n="file_explorer.name">Name</span></th>
                        <th class="size-col"><span data-i18n="file_explorer.size">Size</span></th>
                        <th class="shared-by-col"><span data-i18n="file_explorer.shared_by">Shared by</span></th>
                        <th class="actions-col"><span data-i18n="file_explorer.actions">Actions</span></th>
                    </tr>
                </thead>
                <tbody>
                    {% for folder in shared_folders %}
                    <tr class="file-row shared-row">
                        <td class="icon-col">
                            <div class="file-icon-small folder-icon">
                                <i class="fas fa-folder"></i>
                            </div>
                        </td>
                        <td class="name-col">{{ folder.name }}</td>
                        <td class="size-col">—</td>
                        <td class="shared-by-col">{{ folder.owner_name }}</td>
                        <td class="actions-col"></td>
                    </tr>
                    {% endfor %}
                    {% for file in shared_files %}
                    <tr class="file-row shared-row">
                        <td class="icon-col">
                            <div class="file-icon-small">
                                <i class="fas fa-file"></i>
                            </div>
                        </td>
                        <td class="name-col">{{ file.original_name }}</td>
                        <td class="size-col">{{ format_size(file.size) }}</td>
                        <td class="shared-by-col">{{ file.owner_name }}</td>
                        <td class="actions-col">
                            <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn-icon" title="Download" data-i18n-title="actions.download">
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Create Folder Modal -->
<div id="create-folder-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-folder-plus"></i> <span data-i18n="modals.create_folder">Create New Folder</span></h3>
            <button class="modal-close" onclick="document.getElementById('create-folder-modal').classList.remove('active')">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('create_folder') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="parent_id" value="{{ current_folder.id if current_folder else '' }}">
            <div class="form-group">
                <label for="folder-name" data-i18n="modals.folder_name">Folder Name</label>
                <input type="text" id="folder-name" name="name" required placeholder="Enter folder name" data-i18n-placeholder="modals.enter_folder_name">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary"
                        onclick="document.getElementById('create-folder-modal').classList.remove('active')" data-i18n="actions.cancel">Cancel</button>
                <button type="submit" class="btn btn-primary" data-i18n="actions.create">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Rename Modal -->
<div id="rename-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> <span data-i18n="modals.rename">Rename</span></h3>
            <button class="modal-close" onclick="document.getElementById('rename-modal').classList.remove('active')">&times;</button>
        </div>
        <form id="rename-form" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label for="rename-input" data-i18n="modals.new_name">New Name</label>
                <input type="text" id="rename-input" name="name" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary"
                        onclick="document.getElementById('rename-modal').classList.remove('active')" data-i18n="actions.cancel">Cancel</button>
                <button type="submit" class="btn btn-primary" data-i18n="actions.rename">Rename</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block footer_content %}
<div class="footer-storage-indicator">
    <div class="footer-storage-info">
        <i class="fas fa-database"></i>
        <span data-i18n="file_explorer.storage">Storage</span>:
        <span id="footer-used-space">{{ format_size(user.used_space) }}</span> /
        <span id="footer-quota">{{ format_size(user.quota) }}</span>
    </div>
    <div class="footer-quota-progress">
        <div class="footer-quota-fill" id="footer-quota-fill" style="width: {{ (user.used_space / user.quota * 100) if user.quota > 0 else 0 }}%"></div>
    </div>
</div>
<p class="footer-copyright">&copy; {{ current_year }} {{ app_name }}. All rights reserved.</p>
{% endblock %}

{% block extra_js %}
<script>
// Upload configuration
const currentFolderId = '{{ current_folder.id if current_folder else '' }}';

// Drag and drop upload
const dropZone = document.getElementById('drop-zone');
const uploadForm = document.getElementById('upload-form');
const fileInput = document.getElementById('file-input');
const folderInput = document.getElementById('folder-input');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    document.body.addEventListener(eventName, () => {
        dropZone.classList.add('active');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    document.body.addEventListener(eventName, () => {
        dropZone.classList.remove('active');
    }, false);
});

// Handle file drop with folder structure support
document.body.addEventListener('drop', async (e) => {
    const items = e.dataTransfer.items;
    if (items && items.length > 0) {
        const files = [];
        const relativePaths = [];

        // Check if it contains directories
        const hasDirectory = Array.from(items).some(item => {
            const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
            return entry && entry.isDirectory;
        });

        if (hasDirectory) {
            // Process directories recursively
            for (const item of items) {
                const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                if (entry) {
                    await traverseFileTree(entry, '', files, relativePaths);
                }
            }
            uploadFilesWithProgress(files, relativePaths);
        } else {
            // Simple file upload
            const fileList = e.dataTransfer.files;
            for (let i = 0; i < fileList.length; i++) {
                files.push(fileList[i]);
                relativePaths.push(fileList[i].name);
            }
            uploadFilesWithProgress(files, relativePaths);
        }
    }
}, false);

// Traverse file tree for directory upload
// Note: readEntries may return only partial results, so we must call it repeatedly
async function traverseFileTree(item, path, files, relativePaths) {
    return new Promise((resolve) => {
        if (item.isFile) {
            item.file((file) => {
                files.push(file);
                relativePaths.push(path + file.name);
                resolve();
            }, (error) => {
                // Log error reading file but continue with other files
                console.warn('Error reading file:', path + item.name, error);
                resolve();
            });
        } else if (item.isDirectory) {
            const dirReader = item.createReader();
            const allEntries = [];

            // readEntries may return partial results; must call repeatedly until empty
            const readAllEntries = () => {
                dirReader.readEntries(async (entries) => {
                    if (entries.length > 0) {
                        allEntries.push(...entries);
                        readAllEntries(); // Read more entries
                    } else {
                        // All entries have been read
                        for (const entry of allEntries) {
                            await traverseFileTree(entry, path + item.name + '/', files, relativePaths);
                        }
                        resolve();
                    }
                }, (error) => {
                    // Log error reading directory but continue
                    console.warn('Error reading directory:', path + item.name, error);
                    resolve();
                });
            };
            readAllEntries();
        } else {
            resolve();
        }
    });
}

// Handle file input change
fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        const files = Array.from(fileInput.files);
        const relativePaths = files.map(f => f.name);
        uploadFilesWithProgress(files, relativePaths);
    }
});

// Handle folder input change
folderInput.addEventListener('change', () => {
    if (folderInput.files.length > 0) {
        const files = Array.from(folderInput.files);
        const relativePaths = files.map(f => f.webkitRelativePath || f.name);
        uploadFilesWithProgress(files, relativePaths);
    }
});

// Format time duration for ETA
function formatDuration(seconds) {
    if (!isFinite(seconds) || seconds <= 0) {
        return window.i18n ? window.i18n.t('upload.calculating') : 'Calculating...';
    }

    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);

    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

// Upload files with progress display
function uploadFilesWithProgress(files, relativePaths) {
    if (files.length === 0) return;

    const progressModal = document.getElementById('upload-progress-modal');
    const progressBar = document.getElementById('upload-progress-bar');
    const progressPercent = document.getElementById('upload-progress-percent');
    const progressSize = document.getElementById('upload-progress-size');
    const fileNameSpan = document.getElementById('upload-file-name');
    const fileCountSpan = document.getElementById('upload-file-count');
    const etaSpan = document.getElementById('upload-eta');

    const totalSize = files.reduce((sum, f) => sum + f.size, 0);
    let uploadedSize = 0;
    let completedCount = 0;
    let uploadStartTime = Date.now();
    let lastLoaded = 0;
    let lastTime = uploadStartTime;
    let speedSamples = [];

    // Show progress modal
    progressModal.classList.add('active');
    fileCountSpan.textContent = `(0/${files.length})`;
    if (etaSpan) {
        etaSpan.textContent = window.i18n ? window.i18n.t('upload.estimating') : 'Estimating...';
    }

    const formData = new FormData();
    formData.append('folder_id', currentFolderId);

    // Add CSRF token for security
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
        formData.append('csrf_token', csrfToken.content);
    }

    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
        formData.append('relative_paths', relativePaths[i]);
    }

    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressSize.textContent = formatFileSize(e.loaded) + ' / ' + formatFileSize(e.total);

            // Calculate ETA
            const currentTime = Date.now();
            const timeDiff = (currentTime - lastTime) / 1000; // seconds
            const bytesDiff = e.loaded - lastLoaded;

            if (timeDiff >= 0.5 && bytesDiff > 0) { // Update every 0.5 seconds
                const currentSpeed = bytesDiff / timeDiff; // bytes per second
                speedSamples.push(currentSpeed);

                // Keep only last 5 samples for smoothing
                if (speedSamples.length > 5) {
                    speedSamples.shift();
                }

                // Calculate average speed
                const avgSpeed = speedSamples.reduce((a, b) => a + b, 0) / speedSamples.length;
                const remainingBytes = e.total - e.loaded;
                const eta = remainingBytes / avgSpeed; // seconds

                if (etaSpan) {
                    const etaLabel = window.i18n ? window.i18n.t('upload.remaining_time') : 'Remaining:';
                    etaSpan.textContent = `${etaLabel} ${formatDuration(eta)}`;
                }

                lastLoaded = e.loaded;
                lastTime = currentTime;
            }
        }
    });

    xhr.addEventListener('load', () => {
        progressModal.classList.remove('active');

        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    const count = response.count || 0;
                    showToast('success', window.i18n ? window.i18n.t('upload.success') : `${count} file(s) uploaded successfully`);
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('error', response.error || 'Upload failed');
                }
            } catch (e) {
                // Page reload response (form redirect)
                window.location.reload();
            }
        } else {
            showToast('error', window.i18n ? window.i18n.t('upload.failed') : 'Upload failed');
        }
    });

    xhr.addEventListener('error', () => {
        progressModal.classList.remove('active');
        showToast('error', window.i18n ? window.i18n.t('upload.error') : 'Upload error');
    });

    xhr.open('POST', '{{ url_for("upload_file_ajax") }}');
    xhr.send(formData);

    fileNameSpan.textContent = files.length > 1
        ? (window.i18n ? window.i18n.t('upload.multiple_files') : `${files.length} files`)
        : files[0].name;
}

// Format file size helper
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Toast notification helper
function showToast(type, message) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    let icon = 'fa-info-circle';
    if (type === 'success') icon = 'fa-check-circle';
    else if (type === 'error') icon = 'fa-exclamation-circle';
    else if (type === 'warning') icon = 'fa-exclamation-triangle';

    toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
    `;

    container.appendChild(toast);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.classList.add('toast-fadeout');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Rename modal
function openRenameModal(type, id, currentName) {
    const modal = document.getElementById('rename-modal');
    const form = document.getElementById('rename-form');
    const input = document.getElementById('rename-input');

    if (type === 'file') {
        form.action = `/file/${id}/rename`;
    } else {
        form.action = `/folder/${id}/rename`;
    }

    input.value = currentName;
    modal.classList.add('active');
    input.focus();
    input.select();
}

// Close modals on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
            modal.classList.remove('active');
        });
    }
});

// Close modals on backdrop click
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});

// ==================== Checkbox Selection ====================
const selectAllCheckbox = document.getElementById('select-all');
const itemCheckboxes = document.querySelectorAll('.item-checkbox');
const bulkActions = document.getElementById('bulk-actions');
const selectedCountSpan = document.getElementById('selected-count');

function updateSelectionState() {
    const checkedItems = document.querySelectorAll('.item-checkbox:checked');
    const count = checkedItems.length;

    selectedCountSpan.textContent = count;

    if (count > 0) {
        bulkActions.style.display = 'flex';
    } else {
        bulkActions.style.display = 'none';
    }

    // Update select all checkbox state
    if (selectAllCheckbox) {
        if (count === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (count === itemCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
}

if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', () => {
        itemCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateSelectionState();
    });
}

itemCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectionState);
});

// Delete selected items
function deleteSelected() {
    const checkedItems = document.querySelectorAll('.item-checkbox:checked');
    const confirmMsg = window.i18n ? window.i18n.t('confirm.delete_selected') : 'Delete selected items?';

    if (checkedItems.length === 0) return;
    if (!confirm(confirmMsg)) return;

    // Get CSRF token
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';
    if (!csrfToken) {
        alert('CSRF token missing. Please refresh the page.');
        return;
    }

    // Delete items sequentially to avoid database locking issues
    const items = Array.from(checkedItems).map(checkbox => ({
        type: checkbox.dataset.type,
        id: checkbox.dataset.id
    }));

    async function deleteSequentially() {
        for (const item of items) {
            const url = item.type === 'folder' ? `/folder/${item.id}/delete` : `/file/${item.id}/delete`;
            try {
                await fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-CSRF-Token': csrfToken
                    },
                    body: new URLSearchParams({ csrf_token: csrfToken })
                });
            } catch (error) {
                console.error(`Error deleting ${item.type} ${item.id}:`, error);
            }
        }
        window.location.reload();
    }

    deleteSequentially();
}

// ==================== Sorting ====================
const sortToggle = document.getElementById('sort-toggle');
const sortMenu = document.getElementById('sort-menu');
const sortOptions = document.querySelectorAll('.sort-option');
const sortableHeaders = document.querySelectorAll('.sortable');

let currentSort = { field: 'name', order: 'asc' };

// Toggle sort menu
if (sortToggle && sortMenu) {
    sortToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        sortMenu.classList.toggle('active');
    });

    document.addEventListener('click', () => {
        sortMenu.classList.remove('active');
    });
}

// Sort option click handler
sortOptions.forEach(option => {
    option.addEventListener('click', () => {
        const field = option.dataset.sort;
        const order = option.dataset.order;
        sortTable(field, order);
        sortMenu.classList.remove('active');
    });
});

// Sortable header click handler
sortableHeaders.forEach(header => {
    header.addEventListener('click', () => {
        const field = header.dataset.sort;
        let order = 'asc';

        if (currentSort.field === field) {
            order = currentSort.order === 'asc' ? 'desc' : 'asc';
        }

        sortTable(field, order);
    });
});

function sortTable(field, order) {
    currentSort = { field, order };

    const tbody = document.getElementById('file-list');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('.file-row'));

    // Separate folders and files
    const folders = rows.filter(row => row.dataset.type === 'folder');
    const files = rows.filter(row => row.dataset.type === 'file');

    const sortFn = (a, b) => {
        let valA, valB;

        if (field === 'name') {
            valA = a.dataset.name.toLowerCase();
            valB = b.dataset.name.toLowerCase();
        } else if (field === 'size') {
            valA = parseInt(a.dataset.size) || 0;
            valB = parseInt(b.dataset.size) || 0;
        } else if (field === 'date') {
            valA = new Date(a.dataset.date).getTime() || 0;
            valB = new Date(b.dataset.date).getTime() || 0;
        }

        if (valA < valB) return order === 'asc' ? -1 : 1;
        if (valA > valB) return order === 'asc' ? 1 : -1;
        return 0;
    };

    folders.sort(sortFn);
    files.sort(sortFn);

    // Clear and repopulate
    tbody.innerHTML = '';
    folders.forEach(row => tbody.appendChild(row));
    files.forEach(row => tbody.appendChild(row));

    // Update header icons
    sortableHeaders.forEach(header => {
        const icon = header.querySelector('.sort-icon');
        if (header.dataset.sort === field) {
            icon.className = order === 'asc' ? 'fas fa-sort-up sort-icon active' : 'fas fa-sort-down sort-icon active';
        } else {
            icon.className = 'fas fa-sort sort-icon';
        }
    });
}

// ==================== Delete form confirmation with i18n ====================
const CONFIRM_MESSAGES = {
    'confirm.delete_folder': 'Delete this folder and all its contents?',
    'confirm.delete_file': 'Delete this file?'
};

function getConfirmMessage(confirmKey) {
    if (window.i18n) {
        return window.i18n.t(confirmKey);
    }
    return CONFIRM_MESSAGES[confirmKey] || 'Are you sure?';
}

document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const confirmKey = this.dataset.confirmKey;
        const confirmMsg = getConfirmMessage(confirmKey);

        // Use floating modal instead of browser confirm
        if (window.showDeleteConfirmModal) {
            window.showDeleteConfirmModal(confirmMsg, this);
        } else {
            // Fallback to browser confirm if modal not available
            if (confirm(confirmMsg)) {
                this.submit();
            }
        }
    });
});

// Also update the deleteSelected function to use modal
const originalDeleteSelected = window.deleteSelected;
window.deleteSelected = function() {
    const checkedItems = document.querySelectorAll('.item-checkbox:checked');
    const confirmMsg = window.i18n ? window.i18n.t('confirm.delete_selected') : 'Delete selected items?';

    if (checkedItems.length === 0) return;

    if (window.showDeleteConfirmModal) {
        // Create a virtual form for bulk delete
        const bulkDeleteAction = function() {
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';
            if (!csrfToken) {
                alert('CSRF token missing. Please refresh the page.');
                return;
            }

            const items = Array.from(checkedItems).map(checkbox => ({
                type: checkbox.dataset.type,
                id: checkbox.dataset.id
            }));

            const deleteSequentially = async () => {
                for (const item of items) {
                    const url = item.type === 'folder' ? `/folder/${item.id}/delete` : `/file/${item.id}/delete`;
                    try {
                        await fetch(url, {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'X-CSRF-Token': csrfToken
                            },
                            body: new URLSearchParams({ csrf_token: csrfToken })
                        });
                    } catch (error) {
                        console.error(`Error deleting ${item.type} ${item.id}:`, error);
                    }
                }
                window.location.reload();
            };

            deleteSequentially().catch(error => {
                console.error('Error deleting items:', error);
                showToast('error', window.i18n ? window.i18n.t('upload.error') : 'An error occurred while deleting items. Please refresh the page.');
                window.location.reload();
            });
        };

        // Show modal and set up custom confirmation
        const modal = document.getElementById('delete-confirm-modal');
        const messageEl = document.getElementById('delete-confirm-message');
        const confirmBtn = document.getElementById('delete-confirm-btn');

        if (modal && messageEl && confirmBtn) {
            messageEl.textContent = confirmMsg;
            modal.classList.add('active');

            // Remove previous event listener and add new one
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', function() {
                bulkDeleteAction();
                modal.classList.remove('active');
            });
        } else {
            // Fallback
            if (confirm(confirmMsg)) {
                bulkDeleteAction();
            }
        }
    } else {
        // Fallback to original behavior
        if (originalDeleteSelected) {
            originalDeleteSelected();
        }
    }
};
</script>
{% endblock %}
