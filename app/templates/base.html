<!DOCTYPE html>
<html lang="en" data-theme="light" data-lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}{{ site_description }}{% endblock %}">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}{{ app_name }}{% endblock %}</title>
    <!-- Open Graph Protocol meta tags -->
    <meta property="og:title" content="{% block og_title %}{{ app_name }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ site_description }}{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ site_url }}{{ request.path }}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ site_url }}{{ og_image }}{% endblock %}">
    <meta property="og:site_name" content="{{ app_name }}">
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ app_name }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ site_description }}{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{{ site_url }}{{ og_image }}{% endblock %}">
    <!-- Apply theme immediately to prevent flash -->
    <script>
        (function() {
            var savedTheme = localStorage.getItem('theme');
            var theme = savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);

            var collapsed = localStorage.getItem('sidebar_collapsed');
            if (collapsed === '1' && window.innerWidth > 768) {
                document.documentElement.classList.add('sidebar-collapsed');
            }
        })();
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    {% block extra_css %}{% endblock %}
</head>
<body class="{% if session.user_id %}has-sidebar{% endif %}">
    {% if session.user_id %}
    <!-- Left Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('index') }}" class="sidebar-brand" title="{{ app_name }}">
                <i class="fas fa-cloud"></i>
                <span class="sidebar-brand-text">{{ app_name }}</span>
            </a>
            <div class="sidebar-header-actions">
                <button class="sidebar-collapse" id="sidebar-collapse" title="Collapse sidebar">
                    <i class="fas fa-angles-left"></i>
                </button>
                <button class="sidebar-toggle-mobile" id="sidebar-close" title="Close menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('index') }}" class="sidebar-link {% if request.endpoint == 'index' %}active{% endif %}">
                <i class="fas fa-folder"></i>
                <span data-i18n="nav.files">Files</span>
            </a>
            {% if session.role == 'admin' %}
            <a href="{{ url_for('admin_dashboard') }}" class="sidebar-link {% if request.endpoint == 'admin_dashboard' %}active{% endif %}">
                <i class="fas fa-cog"></i>
                <span data-i18n="nav.admin">Admin</span>
            </a>
            {% endif %}
            <a href="{{ url_for('settings_page') }}" class="sidebar-link {% if request.endpoint == 'settings_page' %}active{% endif %}">
                <i class="fas fa-user-cog"></i>
                <span data-i18n="nav.settings">Settings</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <i class="fas fa-user-circle"></i>
                <span class="sidebar-user-name">{{ session.name }}</span>
            </div>
            <div class="sidebar-actions">
                <div class="lang-selector">
                    <button id="lang-toggle" class="lang-btn" title="Language">
                        <i class="fas fa-globe"></i>
                    </button>
                    <div class="lang-dropdown" id="lang-dropdown">
                        <button class="lang-option" data-lang="en">English</button>
                        <button class="lang-option" data-lang="ja">日本語</button>
                    </div>
                </div>
                <button id="theme-toggle" class="theme-btn" title="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
                <form method="POST" action="{{ url_for('logout') }}" class="sidebar-logout-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="sidebar-logout" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </form>
            </div>
        </div>
    </aside>
    
    <!-- Mobile header with menu toggle -->
    <header class="mobile-header">
        <button class="sidebar-toggle" id="sidebar-toggle" title="Open menu">
            <i class="fas fa-bars"></i>
        </button>
        <a href="{{ url_for('index') }}" class="mobile-brand">
            <i class="fas fa-cloud"></i> {{ app_name }}
        </a>
        <div class="mobile-actions">
            <button id="theme-toggle-mobile" class="theme-btn" title="Toggle theme">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>
    {% endif %}

    <main class="main-content {% if session.user_id %}with-sidebar{% endif %}">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'error' %}fa-exclamation-circle{% elif category == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                    {{ message }}
                    <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        {% block footer_content %}
        <p>&copy; {{ current_year }} {{ app_name }}. All rights reserved.</p>
        {% endblock %}
    </footer>

    <!-- Toast notification container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Upload progress modal -->
    <div id="upload-progress-modal" class="upload-progress-modal">
        <div class="upload-progress-content">
            <div class="upload-progress-header">
                <i class="fas fa-cloud-upload-alt"></i>
                <span data-i18n="upload.uploading">Uploading...</span>
            </div>
            <div class="upload-progress-info">
                <span id="upload-file-name"></span>
                <span id="upload-file-count"></span>
            </div>
            <div class="upload-progress-bar-container">
                <div class="upload-progress-bar" id="upload-progress-bar"></div>
            </div>
            <div class="upload-progress-percent">
                <span id="upload-progress-percent">0%</span>
                <span id="upload-progress-size"></span>
            </div>
            <div class="upload-progress-eta">
                <span id="upload-eta" data-i18n="upload.estimating">Estimating...</span>
            </div>
        </div>
    </div>

    <!-- Share link modal -->
    <div id="share-link-modal" class="modal">
        <div class="modal-content share-link-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-link"></i> <span data-i18n="share.link_created">Share Link Created</span></h3>
                <button class="modal-close" onclick="closeShareLinkModal()">&times;</button>
            </div>
            <div class="modal-body share-link-modal-body">
                <p data-i18n="share.link_copied">Link has been copied to clipboard!</p>
                <div class="share-link-display">
                    <input type="text" id="share-link-input" readonly>
                    <button class="btn btn-primary" onclick="copyShareLinkAgain()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeShareLinkModal()" data-i18n="actions.close">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete confirmation modal -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content delete-confirm-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: var(--error-color);"></i> <span data-i18n="confirm.delete_title">Confirm Delete</span></h3>
                <button class="modal-close" onclick="closeDeleteConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="delete-confirm-message"></p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()" data-i18n="actions.cancel">Cancel</button>
                <button type="button" class="btn btn-danger" id="delete-confirm-btn" data-i18n="actions.delete">Delete</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
